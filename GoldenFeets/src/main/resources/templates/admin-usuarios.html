<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Feets - Admin Usuarios</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@400;500;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4D1C95;
            --primary-dark: #3a146e;
            --secondary-color: #6C4AB6;
            --text-color: #2D2727;
            --light-bg: #F5F5F5;
            --card-shadow: 0 10px 20px rgba(0,0,0,0.1);
            --success-color: #198754;
            --error-color: #dc3545;

            /* --- paleta de colores para roles --- */
            --role-admin: #198754;       /* Verde */
            --role-cliente: #0d6efd;     /* Azul */
            --role-gerente_inventario: #fd7e14; /* Naranja */
            --role-distribuidor: #0dcaf0;     /* Cian */
            --role-gerente_entregas: #6f42c1; /* Púrpura */
            --role-default: #6c757d;      /* Gris */
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--light-bg); color: var(--text-color); }
        header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; display: flex; align-items: center; justify-content: space-between; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* --- ESTILOS DE HEADER RESTAURADOS --- */
        header .logo-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        header .delivery-icon {
            font-size: 1.5em;
        }
        /* --- FIN ESTILOS HEADER --- */

        .brand-name { font-family: 'Playfair Display', serif; font-size: 1.5em; }
        .container-admin { max-width: 1200px; margin: 30px auto; background-color: white; box-shadow: var(--card-shadow); border-radius: 15px; overflow: hidden; }
        .admin-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 25px 30px; text-align: center; }
        .admin-header h1 { font-size: 28px; margin: 0; }
        .admin-content { padding: 30px; }
        .table thead { background-color: var(--primary-color); color: white; }
        .badge-status { color: white; font-size: 0.9em; padding: 5px 10px; border-radius: 50px; }
        .badge-active { background-color: var(--success-color); }
        .badge-inactive { background-color: var(--error-color); }

        /* --- LÓGICA DE COLORES DE ROLES --- */
        .role-badge { display: inline-block; padding: 4px 12px; border-radius: 50px; font-size: 0.85em; font-weight: 500; color: white; text-transform: capitalize; margin: 2px; }
        .role-admin { background-color: var(--role-admin); }
        .role-cliente { background-color: var(--role-cliente); }
        .role-gerente_inventario { background-color: var(--role-gerente_inventario); }
        .role-distribuidor { background-color: var(--role-distribuidor); }
        .role-gerente_entregas { background-color: var(--role-gerente_entregas); }
        .role-default { background-color: var(--role-default); } /* Color por defecto */

        .btn-golden { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none; padding: 10px 20px; border-radius: 50px; font-weight: 500; transition: all 0.3s; box-shadow: 0 4px 10px rgba(108, 74, 182, 0.3); }
        .btn-golden:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(108, 74, 182, 0.4); }
        .modal-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
        .form-control:focus, .form-select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 0.25rem rgba(108, 74, 182, 0.25); }
    </style>
</head>
<body>

<header>
    <a th:href="@{/admin/panel}" class="btn btn-light" title="Volver al inicio">
        <i class="fas fa-home"></i>
    </a>
    <div class="logo-title">
        <div class="delivery-icon">
            <i class="fas fa-users-cog"></i>
        </div>
        <h2>Administración</h2>
    </div>

    <div class="d-flex align-items: center">
        <form th:action="@{/logout}" method="post" class="d-inline">
            <button type="submit" class="btn btn-danger" title="Cerrar Sesión">
                <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
            </button>
        </form>
    </div>
</header>
<div class="container-admin">
    <div class="admin-header">
        <h1><i class="fas fa-user-shield me-2"></i>Gestión de Usuarios</h1>
    </div>

    <div class="admin-content">
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert" th:text="${errorMessage}"></div>

        <button class="btn btn-golden mb-4" data-bs-toggle="modal" data-bs-target="#modalUsuario">
            <i class="fas fa-user-plus me-2"></i>Nuevo Usuario
        </button>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Localidad</th>
                    <th>Roles</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${usuarios.isEmpty()}">
                    <td colspan="7" class="text-center text-muted py-4">No hay usuarios registrados.</td>
                </tr>
                <tr th:each="usuario : ${usuarios}">
                    <td th:text="${usuario.idUsuario}">1</td>
                    <td th:text="${usuario.nombre}">Administrador</td>
                    <td th:text="${usuario.email}">admin@goldenfeets.com</td>

                    <td>
                        <span th:if="${usuario.roles.?[nombre == 'ROLE_DISTRIBUIDOR'].size() > 0}"
                              th:text="${usuario.localidad != null ? usuario.localidad : 'Sin Asignar'}"
                              class="fw-bold">
                        </span>
                        <span th:unless="${usuario.roles.?[nombre == 'ROLE_DISTRIBUIDOR'].size() > 0}"
                              class="text-muted">
                              N/A
                        </span>
                    </td>

                    <td>
                        <span th:each="rol : ${usuario.roles}"
                              th:text="${#strings.replace(rol.nombre, 'ROLE_', '')}"
                              class="role-badge"
                              th:classappend="'role-' + ${#strings.toLowerCase(#strings.replace(rol.nombre, 'ROLE_', ''))}">
                        </span>
                    </td>
                    <td>
                        <span class="badge-status" th:classappend="${usuario.activo} ? 'badge-active' : 'badge-inactive'"
                              th:text="${usuario.activo} ? 'Activo' : 'Inactivo'">
                        </span>
                    </td>
                    <td>
                        <a th:href="@{/admin/usuarios/editar/{id}(id=${usuario.idUsuario})}" class="btn btn-sm btn-warning me-2" title="Editar">
                            <i class="fas fa-edit"></i>
                        </a>
                        <form th:action="@{/admin/usuarios/eliminar/{id}(id=${usuario.idUsuario})}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger"
                                    onclick="return confirm('¿Estás seguro de que quieres eliminar a este usuario?');"
                                    title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalUsuario" tabindex="-1" aria-labelledby="modalUsuarioLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/admin/usuarios/guardar}" th:object="${nuevoUsuario}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalUsuarioLabel">Nuevo Usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombre" th:field="*{nombre}" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" th:field="*{email}" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="password" th:field="*{password}" required>
                    </div>
                    <div class="mb-3">
                        <label for="direccion" class="form-label">Dirección</label>
                        <input type="text" class="form-control" id="direccion" th:field="*{direccion}">
                    </div>

                    <div class="mb-3">
                        <label for="rolesModal" class="form-label">Roles</label>
                        <select id="rolesModal" th:field="*{rolesId}" class="form-select" multiple required onchange="toggleLocalidadFieldModal()">
                            <option th:each="rol : ${rolesTodos}"
                                    th:value="${rol.idRol}"
                                    th:text="${rol.nombre}">
                            </option>
                        </select>
                    </div>

                    <div class="mb-3" id="localidad-form-group-modal" style="display: none;">
                        <label for="localidadNueva" class="form-label">Localidad Asignada (Distribuidor)</label>
                        <select class="form-select" id="localidadNueva" th:field="*{localidad}">
                            <option value="">-- Seleccione Localidad --</option>
                            <option th:each="loc : ${localidades}"
                                    th:value="${loc}"
                                    th:text="${loc}">
                            </option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="telefono" class="form-label">Teléfono</label>
                        <input type="tel" class="form-control" id="telefono" th:field="*{telefono}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-golden">Guardar Usuario</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function toggleLocalidadFieldModal() {
        const rolesSelectModal = document.getElementById('rolesModal');
        const localidadDivModal = document.getElementById('localidad-form-group-modal');
        if (!rolesSelectModal || !localidadDivModal) return;

        let esDistribuidor = false;
        for (const option of rolesSelectModal.options) {
            if (option.selected && option.text === 'ROLE_DISTRIBUIDOR') {
                esDistribuidor = true;
                break;
            }
        }
        localidadDivModal.style.display = esDistribuidor ? 'block' : 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const modalUsuario = document.getElementById('modalUsuario');
        if(modalUsuario) {
            modalUsuario.addEventListener('show.bs.modal', function() {
                toggleLocalidadFieldModal();
            });
        }
    });
</script>
</body>
</html>